---
- name: Deploy Home Assistant
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('file', '../../k8s/homelab/home-automation/home-assistant.yaml') | from_yaml_all | list }}"
    kubeconfig: /etc/rancher/k3s/k3s.yaml

- name: Deploy Grocy
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('file', '../../k8s/homelab/home-automation/grocy.yaml') | from_yaml_all | list }}"
    kubeconfig: /etc/rancher/k3s/k3s.yaml

- name: Wait for home automation deployments to be ready
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: "{{ item }}"
    namespace: home-automation
    kubeconfig: /etc/rancher/k3s/k3s.yaml
    wait: true
    wait_condition:
      type: Available
      status: "True"
    wait_timeout: 600
  loop:
    - home-assistant
    - grocy

- name: Get home automation services LoadBalancer IPs
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Service
    namespace: home-automation
    kubeconfig: /etc/rancher/k3s/k3s.yaml
  register: automation_services

- name: Display home automation stack access information
  debug:
    msg: |
      ğŸ  HOME AUTOMATION STACK DEPLOYED!
      ==================================
      
      ğŸ“± Services Available:
      {% for svc in automation_services.resources %}
      {% if svc.spec.type == "LoadBalancer" and svc.status.loadBalancer.ingress is defined %}
      ğŸ”— {{ svc.metadata.name | title | replace('-', ' ') }}: http://{{ svc.status.loadBalancer.ingress[0].ip }}{% if svc.spec.ports[0].port != 80 %}:{{ svc.spec.ports[0].port }}{% endif %}
        ğŸŒ Web: https://{% if svc.metadata.name == 'home-assistant' %}hass{% else %}{{ svc.metadata.name }}{% endif %}.home.lab
      {% endif %}
      {% endfor %}
      
      ğŸ“‹ SETUP INSTRUCTIONS:
      ======================
      
      ğŸ  HOME ASSISTANT:
      â€¢ Access: https://hass.home.lab or LoadBalancer IP:8123
      â€¢ Complete initial setup wizard
      â€¢ Create admin account
      â€¢ Connect smart home devices
      â€¢ Install HACS for additional integrations
      â€¢ Configure automations and scenes
      
      Features:
      âœ… Device discovery on host network
      âœ… Persistent configuration storage
      âœ… SSL/TLS via cert-manager
      âœ… WebSocket support for real-time updates
      
      ğŸ“Š GROCY (ERP for Your Home):
      â€¢ Access: https://grocy.home.lab or LoadBalancer IP:9283
      â€¢ Default login: admin / admin (change immediately!)
      â€¢ Manage groceries, recipes, and household items
      â€¢ Track expiration dates and shopping lists
      â€¢ Inventory management for your home
      
      Features:
      âœ… Grocery management with barcode scanning
      âœ… Recipe database with meal planning
      âœ… Stock management and shopping lists
      âœ… Persistent data storage
      
      ğŸ”§ Advanced Configuration:
      =========================
      
      Home Assistant Add-ons to consider:
      â€¢ ESPHome (for custom IoT devices)
      â€¢ Node-RED (visual automation)
      â€¢ Zigbee2MQTT (Zigbee device integration)
      â€¢ AdGuard Home (network-wide ad blocking)
      
      ğŸ” Monitoring Commands:
        kubectl get pods -n home-automation
        kubectl logs -n home-automation deployment/home-assistant
        kubectl exec -n home-automation deployment/home-assistant -- cat /config/home-assistant.log